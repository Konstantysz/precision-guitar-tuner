name: Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage:
    name: Coverage (Windows Clang)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up MSVC
        uses: microsoft/setup-msbuild@v1.1

      # Pin LLVM version for stability
      - name: Install LLVM and Ninja
        run: |
          choco install llvm --version=20.1.8 -y
          choco install ninja -y
          echo "C:\Program Files\LLVM\bin" >> $GITHUB_PATH
        shell: bash

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "a62ce77d56ee07513b4b67de1ec2daeaebfae51a"

      # RelWithDebInfo provides debug symbols while maintaining performance
      - name: Configure CMake (with coverage)
        run: |
          cmake -B build/Debug-coverage \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DENABLE_COVERAGE=ON \
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" \
            -G Ninja
        shell: bash

      - name: Build with Coverage
        run: cmake --build build/Debug-coverage --parallel

      - name: Generate Coverage Report
        run: python scripts/run-coverage.py --no-build
        shell: bash
        continue-on-error: true
        env:
          PYTHONIOENCODING: utf-8

      - name: Upload Coverage HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-windows
          path: build/Debug-coverage/coverage/html/
          retention-days: 30

      - name: Extract Coverage Statistics
        if: always()
        id: coverage-stats
        run: |
          if [ -f build/Debug-coverage/coverage/coverage.profdata ]; then
            TEST_EXE="build/Debug-coverage/tests/TestKappaCore.exe"
            PROFDATA="build/Debug-coverage/coverage/coverage.profdata"

            llvm-cov report "$TEST_EXE" -instr-profile="$PROFDATA" > coverage-summary.txt
            TOTAL_LINE=$(tail -n 1 coverage-summary.txt)

            LINES_COV=$(echo "$TOTAL_LINE" | awk '{print $10}' | tr -d '%')
            FUNCTIONS_COV=$(echo "$TOTAL_LINE" | awk '{print $7}' | tr -d '%')

            echo "lines_coverage=$LINES_COV" >> $GITHUB_OUTPUT
            echo "functions_coverage=$FUNCTIONS_COV" >> $GITHUB_OUTPUT
            echo "coverage_available=true" >> $GITHUB_OUTPUT
          else
            echo "coverage_available=false" >> $GITHUB_OUTPUT
          fi
        shell: bash
        continue-on-error: true

      - name: Post Coverage Comment to PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageExists = fs.existsSync('build/Debug-coverage/coverage/html');

            let body = '## ðŸ“Š Test Coverage Report\n\n';

            if (coverageExists && '${{ steps.coverage-stats.outputs.coverage_available }}' === 'true') {
              const linesCov = '${{ steps.coverage-stats.outputs.lines_coverage }}';
              const functionsCov = '${{ steps.coverage-stats.outputs.functions_coverage }}';

              body += '### Coverage Statistics\n\n';
              body += '| Metric | Coverage |\n';
              body += '|--------|----------|\n';
              body += `| **Lines** | ${linesCov}% |\n`;
              body += `| **Functions** | ${functionsCov}% |\n`;
            } else {
              body += 'âš ï¸ Coverage report not generated';
            }

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Test Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
        continue-on-error: true
